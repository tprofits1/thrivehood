function sanitizeSlug(slug) {
  // Keep it simple: letters, numbers, dash, underscore only
  return String(slug || "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9_-]/g, "");
}

function buildThrivePageUrl(slug) {
  const safe = sanitizeSlug(slug);
  if (!safe) return null;
  return `https://thrivehood.biz/${safe}`;
}

function renderTeenCircles(circles) {
  teenCirclesLayer.clearLayers();

  (circles || []).forEach(c => {
    if (typeof c.lat !== "number" || typeof c.lng !== "number") return;

    const radiusMeters =
      (typeof c.radiusMeters === "number" && c.radiusMeters > 0)
        ? c.radiusMeters
        : (0.35 * METERS_PER_MILE);

    // 1) Draw the circle
    const circle = L.circle([c.lat, c.lng], {
      radius: radiusMeters,
      color: "#2b7cff",
      weight: 1,
      fillColor: "#2b7cff",
      fillOpacity: 0.10
    }).addTo(teenCirclesLayer);

    // 2) Add a center marker with link
    const url = buildThrivePageUrl(c.thrivepage);

    const marker = L.circleMarker([c.lat, c.lng], {
      radius: 5,
      weight: 2,
      fillOpacity: 1
    }).addTo(teenCirclesLayer);

    const displayName = c.label ? String(c.label) : "View teen";

    if (url) {
      marker.bindPopup(`
        <div style="font-family: system-ui, -apple-system, Segoe UI, sans-serif;">
          <div style="font-size: 13px; font-weight: 700; margin-bottom: 6px;">${displayName}</div>
          <a href="${url}" target="_top" rel="noopener"
             style="display:inline-block; padding:6px 10px; border-radius:999px;
                    background:#4c9949; color:#fff; text-decoration:none; font-size:12px;">
            Open Thrivepage â†’
          </a>
        </div>
      `);
    } else {
      marker.bindPopup(`
        <div style="font-family: system-ui, -apple-system, Segoe UI, sans-serif;">
          <div style="font-size: 13px; font-weight: 700;">${displayName}</div>
          <div style="font-size: 12px; color:#666; margin-top:6px;">
            (No thrivepage slug found)
          </div>
        </div>
      `);
    }

    // Optional: hover label
    if (c.label) marker.bindTooltip(String(c.label), { sticky: true });

    // Optional: click marker -> also notify Wix which teen was clicked
    if (c.id) {
      marker.on("click", () => {
        window.parent.postMessage({
          type: "THRIVEHOOD_TEEN_CLICKED",
          teenId: c.id,
          thrivepage: c.thrivepage || null
        }, "*");
      });
    }
  });

  statusEl.textContent = `Showing ${(circles || []).length} teen service circles in view.`;
}
