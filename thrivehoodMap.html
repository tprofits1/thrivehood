<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Thrivehood Area Selector</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      /* Make the page a vertical stack: map at top, info below */
      body {
        display: flex;
        flex-direction: column;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      #map {
        width: 100%;
        height: 70%;
        flex-shrink: 0;
      }

      .leaflet-control {
        font-family: inherit;
      }

      /* INFO-BOX IS NOW STATIC, NOT OVERLAYING */
      .info-box {
        position: static;
        width: 100%;
        background: rgba(255,255,255,0.95);
        padding: 10px 12px;
        font-size: 14px;
        line-height: 1.4;
        box-sizing: border-box;
        border-top: 1px solid #ddd;
      }

      .btn-confirm {
        display: inline-block;
        margin-top: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        border: none;
        background: #4c9949;
        color: #fff;
        font-size: 13px;
        cursor: pointer;
      }

      #status {
        margin-top: 4px;
        font-size: 12px;
        color: #555;
      }

      #status.error {
        color: #b00020;
      }

      #status.success {
        color: #1b5e20;
      }
    </style>
  </head>

  <body>
    <!-- MAP FIRST -->
    <div id="map"></div>

    <!-- INFO BOX BELOW THE MAP -->
    <div class="info-box">
      <strong>Step 1:</strong> Click the map to choose the center of your 1-mile x 1-mile area.<br />
      <strong>Step 2:</strong> Click “Confirm Area” to send it to Thrivehood.
      <button class="btn-confirm" id="confirmBtn">Confirm Area</button>
      <div id="status">No area selected yet.</div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Approximate 1 mile in meters
      const ONE_MILE_METERS = 1609.34;

      const map = L.map("map").setView([39.9784, -86.1180], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const statusEl = document.getElementById("status");
      const confirmBtn = document.getElementById("confirmBtn");

      let selectedRect = null;
      let selectedBounds = null;
      let reservedRects = []; // rectangles showing other teens' claimed areas

      function setStatus(text, mode) {
        statusEl.textContent = text || "";
        statusEl.classList.remove("error", "success");
        if (mode === "error") statusEl.classList.add("error");
        if (mode === "success") statusEl.classList.add("success");
      }

      function metersToDegrees(lat, meters) {
        const earthRadius = 6378137;
        const dLat = (meters / earthRadius) * (180 / Math.PI);
        const dLng =
          (meters / (earthRadius * Math.cos((Math.PI * lat / 180)))) *
          (180 / Math.PI);
        return { dLat, dLng };
      }

      // Handle clicks to choose 1-mile x 1-mile area
      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        const halfMile = ONE_MILE_METERS / 2;
        const { dLat, dLng } = metersToDegrees(lat, halfMile);

        const north = lat + dLat;
        const south = lat - dLat;
        const east  = lng + dLng;
        const west  = lng - dLng;

        const bounds = L.latLngBounds([south, west], [north, east]);

        if (selectedRect) {
          map.removeLayer(selectedRect);
        }

        selectedRect = L.rectangle(bounds, {
          color: "#4c9949",
          weight: 2,
          fillOpacity: 0.15
        }).addTo(map);

        selectedBounds = bounds;
        map.fitBounds(bounds, { padding: [20, 20] });

        setStatus("Area selected. Click Confirm to save.");
      });

      // Send selection to Thrivehood (Wix)
      confirmBtn.addEventListener("click", function () {
        if (!selectedBounds) {
          alert("Please click on the map to select an area first.");
          return;
        }

        const data = {
          type: "THRIVEHOOD_AREA_SELECTED",
          bounds: {
            southWest: selectedBounds.getSouthWest(),
            northEast: selectedBounds.getNorthEast()
          }
        };

        window.parent.postMessage(data, "*");
        setStatus("Sending area to Thrivehood...");
      });

      // Listen for messages *from* Wix
      window.addEventListener("message", function (event) {
        const data = event.data || {};
        if (!data.type) return;

        // 1) Draw existing reserved areas
        if (data.type === "THRIVEHOOD_EXISTING_AREAS") {
          // data.areas = [{ south, west, north, east }, ...]
          // Clear previous
          reservedRects.forEach(r => map.removeLayer(r));
          reservedRects = [];

          (data.areas || []).forEach(a => {
            const bounds = L.latLngBounds(
              [a.south, a.west],
              [a.north, a.east]
            );
            const rect = L.rectangle(bounds, {
              color: "#b00020",
              weight: 2,
              fillOpacity: 0.2,
              interactive: false
            }).addTo(map);
            reservedRects.push(rect);
          });

          return;
        }

        // 2) Conflict: overlap with another teen's area
        if (data.type === "THRIVEHOOD_AREA_CONFLICT") {
          if (selectedRect) {
            selectedRect.setStyle({
              color: "#b00020",
              fillOpacity: 0.25
            });
          }
          setStatus("That 1-mile block is already reserved. Please choose a different area.", "error");
          return;
        }

        // 3) Confirmed: area successfully reserved
        if (data.type === "THRIVEHOOD_AREA_CONFIRMED") {
          if (selectedRect) {
            selectedRect.setStyle({
              color: "#4c9949",
              fillOpacity: 0.25
            });
          }
          setStatus("Your 1-mile service area is reserved!", "success");
          // Optional: prevent changing it again
          // confirmBtn.disabled = true;
          return;
        }
      });
    </script>
  </body>
</html>



